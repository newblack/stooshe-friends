// Generated by CoffeeScript 1.6.1
(function() {

  $.fn.extend({
    fb_perms: function(callback) {
      return this.each(function(element) {
        return $(this).click(function() {
          return FB.login(function(res) {
            if (res.authResponse) {
              return callback.success();
            } else {
              return callback.fail();
            }
          }, {
            scope: $(this).data('perms')
          });
        });
      });
    },
    fb_api: function(lookup, callback) {
      return FB.api(lookup, function(res) {
        return callback(res);
      });
    },
    fb_fql: function(query, callback) {
      return FB.api({
        method: 'fql.query',
        query: query
      }, function(res) {
        return callback(res);
      });
    }
  });

  /* --------------------------------------------
       Begin script.coffee
  --------------------------------------------
  */


  window.friends = {};

  window.content = '';

  window.score = function(user, score, time) {
    if (window.friends["" + user]) {
      if (window.friends["" + user].last < time) {
        window.friends["" + user].last = time;
      }
      return window.friends["" + user].score = window.friends["" + user].score + score;
    }
  };

  window["switch"] = function(text) {
    var count;
    count = $('.js__count');
    return count.fadeOut(function() {
      count.html(text);
      return count.fadeIn();
    });
  };

  $(function() {
    $('.js__perms').fb_perms({
      success: function() {
        return $().fb_api("/me/friends", function(friends) {
          return $('.message').fadeOut(function() {
            $('.message').html("<h2 class='secondary js__count'>Analysing your friends</h2>");
            return $('.message').fadeIn(function() {
              var i;
              i = 1;
              $(friends.data).each(function(id, friend) {
                window["switch"]("reviewing " + i + " friends");
                i++;
                return window.friends["" + friend.id] = {
                  name: friend.name,
                  score: 0,
                  last: 0
                };
              });
              return $().fb_api("/me", function(user) {
                var query;
                window.user = user;
                query = "SELECT actor_id, created_time, type, comments, likes FROM stream WHERE source_id = me() AND type != 237 AND actor_id != '' LIMIT 10000";
                return $().fb_fql(query, function(data) {
                  window["switch"]("going through your feed");
                  $(data).each(function(id, user) {
                    var time;
                    time = user.created_time;
                    window.score(user.actor_id, 4, Date.parse(time));
                    $(user.comments.comment_list).each(function(id, user) {
                      return window.score(user.fromid, 1, Date.parse(time));
                    });
                    return $(user.likes).each(function(id, likes) {
                      return $(likes.friends).each(function(id, user) {
                        return window.score(user, 1, Date.parse(time));
                      });
                    });
                  });
                  return $().fb_api("/me/threads", function(messages) {
                    window["switch"]("importing inbox messages");
                    $(messages.data).each(function(id, message) {
                      var count, time;
                      count = message.message_count;
                      time = message.messages.data[0].created_time;
                      return $(message.senders.data).each(function(id, sender) {
                        return $(sender).each(function(id, sender) {
                          return window.score(sender.id, count, Date.parse(time));
                        });
                      });
                    });
                    i = 0;
                    $(Object.keys(window.friends)).each(function(id, friend) {
                      var time, vis;
                      user = window.friends[friend];
                      time = new Date() - new Date(user.last);
                      time = Math.floor(time / (24 * 3600 * 1000));
                      if (time < (30.5 * 4)) {
                        return delete window.friends[friend];
                      } else {
                        if (user.last === 0) {
                          return delete window.friends[friend];
                        } else {
                          vis = '';
                          if (i > 14) {
                            vis = 'hidden';
                          }
                          window.content = window.content + ("													<div class='profile__wrapper " + vis + "'>														<img 															src='https://graph.facebook.com/" + friend + "/picture?return_ssl_resources=1&type=large'															alt='" + user.name + "'															class='profile__pic'															data-id='" + friend + "'														>													</div>												");
                          return i++;
                        }
                      }
                    });
                    return setTimeout(function() {
                      return $('.message').fadeOut(function() {
                        $('.message').addClass("message--large").removeClass('message').html("												<h2 class='secondary'>Choose <span class='friends-name'>a friend...</span></h2>												<div class='profile'>													" + window.content + "												</div>												<a class='button'>Confirm</a>													");
                        return $('.message--large').fadeIn();
                      });
                    }, 6000);
                  });
                });
              });
            });
          });
        });
      },
      fail: function() {
        return alert('please accept the permissions to continue');
      }
    });
    return $('.page').on("click", ".profile__wrapper", function() {
      var $this;
      $this = $(this);
      $('.profile__selected').removeClass('profile__selected');
      $(this).addClass('profile__selected');
      return $('.friends-name').fadeOut(function() {
        $('.friends-name').html($this.children('.profile__pic').attr('alt'));
        return $('.friends-name').fadeIn();
      });
    });
  });

}).call(this);
